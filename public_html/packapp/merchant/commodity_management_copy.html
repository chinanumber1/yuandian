<!DOCTYPE html>
<html lang="zh-CN" manifest="appcache.php">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
   <title>商品管理</title>
    <link href="css/mui.css" rel="stylesheet"/>
    <link rel="stylesheet" type="text/css" href="css/commodity_management.css"/>
    <style>
		.mui-col-sm-2 {
		    width: 33.3%!important;
		    text-align: center;
		}
    </style>
</head>
<body>
	<header class="mui-bar mui-bar-nav mui-clearfix">
	    <div class=" mui-icon mui-icon-left-nav mui-pull-left" data-url="back" ></div>
	    <h1 class="mui-title">商品管理</h1>
	    
	    <span class="mui-pull-right hidden" id="cancel">完成</span>
	    <!--<div style="clear: both;"></div>-->
	</header>
	<div class="mui-content">
		<div class="commod">
			<div class="search">
				<p><i></i> <span>商品名称</span></p>
		    	<!-- <div class="mui-input-row mui-search">
					<input type="search" class="mui-input-clear" placeholder="商品名称" readonly>
				</div> -->
		    </div>
		</div>
	    
	    <div class="mui-content mui-row">
			<div class="mui-col-xs-3">
				<div id="segmentedControls" class=" mui-segmented-control-inverted mui-segmented-control-vertical">
					<dl class="classHtml">
						<!-- <dd  class="first_list active">
							<i><b class="mui-pull-left"></b><span>营养早餐</span><sub class="mui-pull-right"></sub></i>
							
						</dd>
						<dd  class="first_list">
							<i><b class="mui-pull-left"></b><span>鲜榨蔬汁</span><sub class="mui-pull-right"></sub></i>
							
						</dd>
						<dd  class="first_list">
							<i><b class="mui-pull-left"></b><span>蔬菜瓜果</span><sub class="mui-pull-right"></sub></i>
							
						</dd>
						<dd  class="first_list">
							<i><b class="mui-pull-left"></b><span>蔬菜瓜果</span><sub class="mui-pull-right"></sub></i>
							
						</dd>
						<dd  class="first_list">
							<i><b class="mui-pull-left"></b><span>蔬菜瓜果</span><sub class="mui-pull-right"></sub></i>
							
						</dd>
						<dd  class="first_list">
							<i><b class="mui-pull-left"></b><span>蔬菜瓜果</span><sub class="mui-pull-right"></sub></i>
							
						</dd> -->
					</dl>
				</div>
			</div>
			<div id="segmentedControlContents" class="mui-col-xs-9">
				<p class="all_checkbox"><b></b><span>全选</span><i class="yiselect">(已选0件)</i></p>
				<div class="all_change_show">
					<p></p>
					<div class="all_fenlei">
						<!-- <ul class="goods_news">
							<li class="mui-clearfix" data-goodid="133">         <i data-goodid="133" class=" mui-pull-left check_tiggle" style="display: none;"></i>            <img class="mui-pull-left" src="http://www.group.com/upload/goods/000/000/001/s_581027da96409935.jpg">         <sub class="floor" style="display:none;">已下架</sub>        <ul class="mui-pull-left">     <li>披萨</li>     <li>             <sapn>原始库存30</sapn>             <span>月售32</span>     </li>     <li><b>￥10</b> <span>当前库存1800</span></li>    </ul>         <div class="mui-media-body hide_btn">      <button data-goodid="133" type="button" class="goods_modify">修改</button>             <button data-goodid="133" type="button" class="goods_off">下架</button>            <button data-goodid="133" type="button" class="goods_size">规格</button>     </div>           </li>
							<li class="mui-clearfix" data-goodid="134">         <i data-goodid="134" class=" mui-pull-left check_tiggle" style="display: none;"></i>            <img class="mui-pull-left" src="http://www.group.com/upload/goods/000/000/001/s_5810289275dc0742.jpg">         <sub class="floor">已下架</sub>        <ul class="mui-pull-left">     <li>小蛋糕</li>     <li>            <sapn>无限量库存</sapn>            <span>月售31</span>     </li>     <li><b>￥10</b> <span>当前库存1800</span></li>    </ul>         <div class="mui-media-body hide_btn">      <button data-goodid="134" type="button" class="goods_modify">修改</button>             <button data-goodid="134" type="button" class="goods_off">上架</button>            <button data-goodid="134" type="button" class="goods_size">规格</button>     </div>           </li>	
						</ul> -->
					</div>
					
				</div>
				
			</div>
		</div>
		<div style="padding-bottom: 55px;"></div>
		<nav class="mui-bar mui-bar-tab shop_guan1">
		    <ul>
		    	<li class="mui-pull-left classified_management"><b></b><span>分类管理</span></li>
		    	<li class="mui-pull-left new_merchandise"><b></b><span>新建商品</span></li>
		    	<li class="mui-pull-left batch_management"><b></b><span>批量管理</span></li>
		    </ul>
		</nav>
		<nav class="mui-bar mui-bar-tab shop_change hidden">
			<div class="mui-row mui-clearfix">
			    <div class="mui-col-sm-2 goods_upshelves">
			    	<ul>
		    			<li><i></i></li>
		    			<li>上架</li>
		    		</ul>
			    </div>
			    
			    <div class="mui-col-sm-2 goods_downshelves">
			    	<ul>
		    			<li><i></i></li>
		    			<li>下架</li>
		    		</ul>
			    </div>
			    <!-- <a href="#forward" class="mui-col-sm-2 goods_over">
			    	<div >
				    	<ul>
			    			<li><i></i></li>
			    			<li>库存</li>
			    		</ul>
			    	</div>
			    </a>
			     -->
			    <div class="mui-col-sm-2" id="delate_goods">
			    	<ul>
			    		<li><i></i></li>
			    		<li>删除</li>
			    	</ul>
			    </div>
			</div>
		</nav>
	</div>
	<!-- <div id="forward" class="mui-popover mui-popover-action mui-popover-bottom">
			<ul class="mui-table-view">
				<li class="mui-table-view-cell">
					<a href="#" class="enpoty">置空</a>
				</li>
				<li class="mui-table-view-cell">
					<a href="#" class="fill">填满</a>
				</li>
				<li class="mui-table-view-cell">
					<a href="#" class="custom">自定义</a>
				</li>
			</ul>
			<ul class="mui-table-view">
				<li class="mui-table-view-cell">
					<a href="#forward">取消</a>
				</li>
			</ul>
		</div> -->
		<!--自定义库存-->
		<!-- <div class="custom_content"></div>
		<div class="custom_header">
			<p class="mui-clearfix"><span>自定义库存</span><a href="javascript:void(0);" class="mui-pull-right">保存</a></p>
			<div class="now_custom">
				<span class="left_style">当前库存:</span>
				<input type="tel" name="" id="" value="" />
			</div>
		</div> -->
		<!--底部栏遮罩层-->
		<div class="bottom_bg">
			
		</div>
<script src="js/fastclick.js"></script>
<script src="js/mui.min.js"></script>
<script type="text/javascript" src="js/jquery-1.9.1.min.js"></script>
<script src="js/laytpl.js" type="text/javascript" charset="utf-8"></script>
<script src="js/layer/layer.m.js" type="text/javascript" charset="utf-8"></script>
<script src="js/common.js" type="text/javascript" charset="utf-8"></script>
<script type="text/javascript" charset="utf-8">
	mui.init();
	var ticket = common.getCache('ticket');
	var client = common.checkAndroidApp()  ?  2 : (common.checkIosApp() ? 1 : 0);
	var shopId=$.getUrlParam('store_id');//店铺ID
	var sort_id='';//默认渲染商品ID
	var type=0;//根据用户是否点击批量管理按钮修改样式
	//初次加载页面渲染三级分类
	common.http('WapMerchant&a=foodshopGoods',{'ticket':ticket,'client':client,'store_id':shopId,'sort_id':sort_id},function(data){
		console.log(data);
		if(data!=null){
			$('.all_change_show>p').text(data[0].sort_name);
			var str='',sum='';
			$.each(data,function(i,val){	
				if(i==0){
					str+='<dd  class="first_list active"><i><b class="mui-pull-left"></b><span>'+data[i].sort_name+'</span><sub class="mui-pull-right"></sub></i></dd>';
					sum+='<ul class="goods_news">'
				}else{
					str+='<dd  class="first_list"><i><b class="mui-pull-left"></b><span>'+data[i].sort_name+'</span><sub class="mui-pull-right"></sub></i></dd>';
					sum+='<ul  class="goods_news" style="display:none;">'
				}

				if(val.goodsList!=[]){
					$.each(val.goodsList,function(j,text){
						sum+='<li class="mui-clearfix" data-goodid='+text.goods_id+'><i data-goodid='+text.goods_id+' class=" mui-pull-left check_tiggle" style="display: none;"></i><img class="mui-pull-left" src='+text.pic_arr[0].url+'  >';
						if(text.status==0){
							sum+='<sub class="floor">已下架</sub>';
						}else{
							sum+='<sub class="floor" style="display:none;">已下架</sub>';
						}
						sum+=' <ul class="mui-pull-left"><li>'+text.name+'</li><li>';
						if(text.stock_num=="-1"){//<sapn>无限量库存</sapn>
							sum+='<span>月售 '+text.sell_count+'</span></li>';
						}else{
							sum+='<sapn>原始库存'+text.stock_num+'</sapn><span>月售'+text.sell_count+'</span></li>';
						} //<span>当前库存1800</span>
						sum+='<li><b>￥'+text.price+'</b></li></ul><div class="mui-media-body hide_btn">      <button data-goodid='+text.goods_id+' type="button" class="goods_modify">修改</button> ';
						if(text.status==0){
							sum+='<button data-goodid='+text.goods_id+' type="button" class="goods_off">上架</button>';

						}else{
							sum+='<button data-goodid='+text.goods_id+' type="button" class="goods_off">下架</button>';
						}
						sum+=' <button data-goodid='+text.goods_id+' type="button" class="goods_size">规格</button></div></li>';
						
					});
				}
				sum+='</ul>';
				
			});//遍历结束
			$('.classHtml').html(str);
			$('.all_fenlei').html(sum);
		}else{
			mui.toast('还没有分类哦,快去添加吧');
		}
		
	});



	//一级列表点击
	mui('#segmentedControls').on('tap','dl dd',function(e){
		$(this).addClass('active').siblings('dd').removeClass('active');
		var text=$(this).find('span').text();
		$('.all_change_show>p').text(text);
		var index=$(this).index();
		$('.all_fenlei>ul:eq('+index+')').show().siblings('ul').hide();
		// var lengths=$('.all_fenlei>ul:eq('+index+')>li').length;
		// if(lengths==0){
		// 	mui.toast('此分类下还没有可以操作的商品，先去添加吧');
		// 	$('.all_checkbox').hide();
		// }else{
		// 	$('.all_checkbox').show();
		// }
	});
	

	//商品上下架点击
	$('.mui-content').unbind('click','.goods_off').on('click','.goods_off',function(e){
		e.stopPropagation();
		var goods_ids=$(this).attr('data-goodid');
		var me=this;
		if($(this).text()=="上架"){
			common.http('WapMerchant&a=updateFoodStatus ',{'ticket':ticket,'client':client,'store_id':shopId,'goods_ids':goods_ids,'status':1},function(data){
				mui.toast('上架成功');
				$(me).parents('li.mui-clearfix').find('.floor').hide();
				$(me).text('下架');
			});
		}else{
			
			common.http('WapMerchant&a=updateFoodStatus ',{'ticket':ticket,'client':client,'store_id':shopId,'goods_ids':goods_ids,'status':0},function(data){
				mui.toast('下架成功');
				$(me).parents('li.mui-clearfix').find('.floor').show();
				$(me).text('上架');
			});

		}
		// return false;
	});

var chuHeight='';
if(common.checkIosApp()){
	chuHeight=$(window).height()-158;

}else{
	 chuHeight=$(window).height()-138;
}
$('.mui-col-xs-3').css('height',chuHeight);
$('.mui-col-xs-9').css('height',chuHeight);
	
//批量管理点击
mui('.mui-content').on('tap','.batch_management',function(e){
	type=1;//按钮隐藏 选择框显示
	$('.mui-bar-nav span').removeClass('hidden');
	$('.goods_news li i').show();
	$('.commod').hide();
	$('.all_checkbox').show();
	$('.all_change_show').addClass('active');
	$('.shop_guan1').addClass('hidden').next('nav').removeClass('hidden');
	$('.hide_btn').hide();
	$('.floor').addClass('active');
	$('.mui-col-xs-3').css('height',chuHeight+44);
	$('.mui-col-xs-9').css('height',chuHeight+44);
	var lengths=$('.goods_news>li>i.active').length;
	$('.all_change_show>p').hide();
	$('.goods_news>li i.check_tiggle').removeClass('active');
	$('.yiselect').text('已选0件');
	$('.all_checkbox').removeClass('active');
	$('.bottom_bg').show();
	$('.goods_news li img').css('margin-left','0');
	$('.bottom_bg').click(function(e){
		mui.toast('请先选择商品后操作');
	});
	//下架点击
	mui('.shop_change').on('tap','.goods_downshelves',function(e){
		
		var goods_id=[];
		$.each($('.goods_news>li.mui-clearfix'),function(i,val){
			if($(this).find('.check_tiggle').is('.active')){
				goods_id.push($(this).attr('data-goodid'));
				$(this).find('.floor').show();
				$(this).find('.goods_off').text('上架');
			}
		});
		// $('.bottom_bg').show();
		common.http('WapMerchant&a=updateFoodStatus',{'ticket':ticket,'client':client,'store_id':shopId,'goods_ids':goods_id,'status':0},function(data){
			// if(data.lengths==0){
				mui.toast('下架成功');
			// }
		});
	});
	//上架点击
	mui('.shop_change').on('tap','.goods_upshelves',function(e){
		var goods_id=[];
		$.each($('.goods_news>li.mui-clearfix'),function(i,val){
			if($(this).find('.check_tiggle').is('.active')){
				goods_id.push($(this).attr('data-goodid'));
				$(this).find('.floor').hide();
				$(this).find('.goods_off').text('下架');
			}
		});
		// $('.bottom_bg').show();
		common.http('WapMerchant&a=updateFoodStatus',{'ticket':ticket,'client':client,'store_id':shopId,'goods_ids':goods_id,'status':1},function(data){
			// if(data.lengths==0){
				mui.toast('上架成功');
			// }
		});
	});
	//复选框点击事件check_tiggle
	$('.goods_news').off('click','.check_tiggle').on('click','.check_tiggle',function(e){
		e.stopPropagation();
		if($(this).is('.active')){
			$(this).removeClass('active')
		}else{
			$(this).addClass('active');
		}
		var lengths=$('.goods_news>li>i.active').length;
		$('.all_checkbox').find('i').html('(已选'+lengths+'件)');
		if(lengths==$('.goods_news>li').length){
			$('.all_checkbox').addClass('active');
		}else{
			$('.all_checkbox').removeClass('active');
		}
  		if(lengths>0){
  			$('.bottom_bg').hide();
  		}else{
  			$('.bottom_bg').show();
  			$('.all_checkbox').removeClass('active');
  		}
	});
	//全选点击all_checkbox
	$('.all_checkbox').unbind('click').click(function(e){
		if($(this).is('.active')){
			$(this).removeClass('active');
			$('.goods_news>li>i').removeClass('active');
			var len=$('.goods_news>li i.active').length;
   			//console.log(len);
   			$(this).find('i').html('(已选'+len+'件)');
		}else{
			$(this).addClass('active');
			$('.goods_news>li>i').addClass('active');
			var len=$('.goods_news>li i.active').length;
   			//console.log(len);
   			$(this).find('i').html('(已选'+len+'件)');
		}
		var lengths=$('.goods_news>li>i.active').length;
		//console.log(lengths);
  		if(lengths>0){
  			$('.bottom_bg').hide();
  		}else{
  			$('.bottom_bg').show();
  			
  		}
	});
	//删除按钮点击  delate_goods  cancel
	$('.shop_change').off('click','#delate_goods').on('click','#delate_goods',function(e){
		e.stopPropagation();
		mui.confirm('你确认删除这些商品吗？',/* btnArray, */function(e) {
			if (e.index == 1) {
				var goods_id=[];
				$.each($('.goods_news>li.mui-clearfix'),function(i,val){
					if($(this).find('.check_tiggle').is('.active')){
						goods_id.push($(this).attr('data-goodid'));
						$(this).remove();
					}
				});
				$('.bottom_bg').show();
				$('.all_checkbox .yiselect').text('已选0件');
				$('.all_checkbox').removeClass('active');
				common.http('WapMerchant&a=foodDel',{'ticket':ticket,'client':client,'store_id':shopId,'goods_ids':goods_id},function(data){
					console.log(data);
					if(data.lengths==0){
						mui.toast('删除成功');
						
					}
				});
			}
		})
	});
	//完成按钮点击
	mui('.mui-bar-nav').on('tap','#cancel',function(e){
		type=0;//按钮显示 选择框隐藏
		$('.mui-bar-nav span').addClass('hidden');
		$('.goods_news li i').hide();
		$('.goods_news li img').css('margin-left','5%');
		$('.goods_news>li i.check_tiggle').removeClass('active');
		$('.all_checkbox').hide();
		$('.bottom_bg').hide();
		$('.hide_btn').show();
		$('.shop_change').addClass('hidden').prev('nav').removeClass('hidden');
		$('.floor').removeClass('active');
		$('.commod').show();
		$('.all_change_show').removeClass('active');
		$('.mui-col-xs-3').css('height',chuHeight);
		$('.mui-col-xs-9').css('height',chuHeight);
		$('.all_checkbox').hide();
		$('.all_change_show').removeClass('active');
		$('.bottom_bg').hide();
	});
});

//点击分类管理
mui('.mui-content').on('tap','.classified_management',function(e){
	//window.location.href='class_list_copy.html?store_id='+shopId;
	openWindow({
		url:'class_list_copy.html?store_id='+shopId,
		id:'class_list_copy'
	});
});

//点击新建商品
mui('.mui-content').on('tap','.new_merchandise',function(e){
	e.stopPropagation();
	e.preventDefault();
	openWindow({
		url:'add_goods_copy.html?addType=0&store_id='+shopId,
		id:'class_list_copy'
	});
});

//点击修改
mui('.mui-content').on('tap','.goods_modify',function(e){
	e.stopPropagation();
	e.preventDefault();
	var id=$(this).attr('data-goodid');
	openWindow({
		url:'add_goods_copy.html?addType=1&goods_id='+id+'&store_id='+shopId,
		id:'class_list_copy'
	});
});

//点击规格
mui('.mui-content').on('tap','.goods_size',function(e){
	e.stopPropagation();
	e.preventDefault();
	var id=$(this).attr('data-goodid');
	openWindow({
		url:'goods_size_copy.html?goods_id='+id,
		id:'class_list_copy'
	});
});

//点击搜索框
$('.search').on('tap',function(e){
	mui.openWindow({
		url:'search_copy.html?data='+shopId,
		id:'search'
	});
});
 function pageShowFunc(){
	window.location.reload(true);
}
</script>
</body>
</html>